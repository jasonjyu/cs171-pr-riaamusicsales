<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>RIAA Music Sales</title>

    <!-- Libraries -->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/d3/d3.parcoords.js" charset="utf-8"></script>
    <script src="libs/d3/queue.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="css/d3.parcoords.css">
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
    <link rel="stylesheet" type="text/css"
          href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Our JavaScript Files  -->
    <script src="js/dataset.js" type="text/javascript"></script>
    <script src="js/metadata.js" type="text/javascript"></script>
    <script src="js/milestoneVis.js" type="text/javascript"></script>
    <script src="js/contextVis.js" type="text/javascript"></script>
    <script src="js/focusVis.js" type="text/javascript"></script>
    <script src="js/rankingVis.js" type="text/javascript"></script>

    <!-- Our Stylesheets -->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">
</head>
<body>
    <header>
      <div class="inner">
        <h1>RIAA Music Sales</h1>
        <a href="https://github.com/jasonjyu/cs171-pr-riaamusicsales"
           class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>
    <div class="container col-md-2" style="float:left;">
        <div class="text-center">
            <span class="chartTitle">controls</span>
        </div>
        <div class="text-center" id="metricControl1"></div>
        <div class="text-center" id="metricControl2"></div>
        <br>
        <div class="text-center" id="formatControl"></div>

        <br><br>

        <div class="text-center" id="milestoneVis">
            <span class="chartTitle">milestone guide</span>
            <br>
            <p class="description">
                Click the buttons to toggle through some music milestones.
            </p>
            <div id="milestoneControl"></div>
        </div>
    </div>
    <div class="container" style="float:left;">
        <div class="row">
            <div class="col-md-12 text-center" id="contextVis">
                <span class="chartTitle">context overview</span>
                <br>
                <p class="description">
                    Brush the chart to select a time interval,
                    then drag the selection.
                </p>
            </div>
        </div>

        <br><br>

        <div class="row">
            <div class="col-md-7 text-center" id="focusVis1">
                <span class="chartTitle">focus selection #1</span>
                <br>
                <p class="description">
                    Hover over a format to highlight.
                    Drag side slider to rescale.
                    Click on title to toggle the data view.
                </p>
            </div>
            <div class="col-md-5 text-center" id="rankingVis1">
                <span class="chartTitle">rankings #1</span>
                <br>
            </div>
        </div>

        <br><br>

        <div class="row">
            <div class="col-md-7 text-center" id="focusVis2">
                <span class="chartTitle">focus selection #2</span>
                <br>
                <p class="description">
                    Hover over a format to highlight.
                    Drag side slider to rescale.
                    Click on title to toggle the data view.
                </p>
            </div>
            <div class="col-md-5 text-center" id="rankingVis2">
                <span class="chartTitle">rankings #2</span>
                <br>
            </div>
        </div>

        <br><br>

        <div class="text-center">
            <span class="chartTitle">parallel coordinates chart</span>
            <p class="description">
                Brush or reorder the axes.
            </p>
        </div>
        <div id="paraVis" class="col-md-12 parcoords" style="height:270px;">
        </div>
    </div>
    <script>
        // this function is called after the HTML document is fully loaded
        $(function() {

            // keeps global knowledge of the data types in the dataset
            var dataset;

            // keeps metadata about the dataset
            var metadata;

            var bindControlsMetric = function(controlElement, controlTitle,
                defaultCheckedIndex, eventHandler, eventName) {

                var form = controlElement
                    .classed("control", true)
                    .text(controlTitle);

                var dropdown = form.append("select")
                    .attr("class", "option")
                    .attr("name", "metric")
                    .on("change", function() {
                        $(eventHandler).trigger(eventName, dataset[this.value]);
                    });

                // create a dropdown menu option for each metric
                Object.keys(dataset).forEach(function(metric, i) {
                    dropdown.append("option")
                        .attr("value", metric)
                        .attr("selected", i === defaultCheckedIndex ? "" : null)
                        .text(dataset[metric].name);
                });
            };

            var bindControlsFormat = function(controlElement, controlTitle,
                eventHandler, eventName) {

                var form = controlElement
                    .classed("control", true)
                    .text(controlTitle);

                var dropdown = form.append("select")
                    .attr("class", "option")
                    .attr("name", "format")
                    .attr("multiple", "")
                    .style("height", "305px")
                    .style("width", "200px")
                    .on("change", function() {
                        $(eventHandler).trigger(eventName, [$(this).val()]);
                    });

                // generate an array of unique formats
                var formats = Object.keys(d3.nest().key(function(d) {
                    return d.format;
                }).map(dataset.dollars.data));

                // create a dropdown menu option for each format
                formats.forEach(function(format) {
                    dropdown.append("option")
                        .attr("value", format)
                        .text(format);
                });
            };

            var bindControlsMilestone = function(controlElement,
                controlHtmlText, controlFunction) {

                controlElement.append("button")
                    .attr("class", "btn-primary")
                    .html(controlHtmlText)
                    .on("click", controlFunction);
            };

            // Loads data and creates the parallel coordinates chart
            var createParaVis = function() {

                var colors = function(d){return metadata.colorMap[d]};
                d3.csv('data/paradata.csv', function(data) {

                        var color = function(d) {return colors(d.format);};

                        var parcoords = d3.parcoords()("#paraVis")
                                .data(data)
                                .color(color)
                                .alpha(0.25)
                                .composite("darken")
                                .margin({ top: 24, left: 50, bottom: 12, right: 0 })
                                .mode("queue")
                                .render()
                                .brushMode("1D-axes")
                                .reorderable();

                        parcoords.svg.selectAll("text")
                                .style("font", "10px sans-serif");
                });
            };

            // call this function after data is loaded,
            // reformatted and bound to the variables
            var initVis = function() {

                var myEventHandler = new Object();
                var milestoneVis = new MilestoneVis(d3.select("#milestoneVis"),
                    metadata.milestones, myEventHandler);
                var contextVis = new ContextVis(d3.select("#contextVis"),
                    [dataset.units], [dataset.dollars], myEventHandler);
                var focusVis1 = new FocusVis(1, d3.select("#focusVis1"),
                    dataset.units.data, metadata.colorMap, myEventHandler);
                var focusVis2 = new FocusVis(2, d3.select("#focusVis2"),
                    dataset.dollars.data, metadata.colorMap, myEventHandler);
                var rankingVis1 = new RankingVis(1, d3.select("#rankingVis1"),
                    dataset.units.data, metadata.colorMap, myEventHandler);
                var rankingVis2 = new RankingVis(2, d3.select("#rankingVis2"),
                    dataset.dollars.data, metadata.colorMap, myEventHandler);
                createParaVis();

                // bind sales metric controls
                bindControlsMetric(d3.select("#metricControl1"),
                    "Sales Metric #1:", 0, myEventHandler, "dataChanged1");
                bindControlsMetric(d3.select("#metricControl2"),
                    "Sales Metric #2:", 1, myEventHandler, "dataChanged2");

                // bind music format controls
                bindControlsFormat(d3.select("#formatControl"),
                    "Music Format Filter:", myEventHandler, "formatsChanged");

                // bind milestone controls
                bindControlsMilestone(d3.select("#milestoneControl"), "&laquo",
                    milestoneVis.decrementMilestone(milestoneVis));
                bindControlsMilestone(d3.select("#milestoneControl"), "&raquo",
                    milestoneVis.incrementMilestone(milestoneVis));
            };

            var startHere = function() {

                // load data here and call parseData() afterwards
                queue()
                    .defer(d3.csv, "data/RIAADATA_units.csv")
                    .defer(d3.csv, "data/RIAADATA_value.csv")
                    .defer(d3.csv, "data/RIAADATA_value_inflation_adjusted.csv")
                    .defer(d3.csv, "data/milestones.csv")
                    .await(function(error, rows1, rows2, rows3, rows4) {
                        // process data if no error occurs
                        if (!error) {
                            dataset = new Dataset(rows1, rows2, rows3);
                            metadata = new Metadata(dataset.dollars.data,
                                rows4);
                            initVis();
                        }
                    });
            };

            startHere();
        });

        /**
         * Helper function that gets the width of a DOM element
         * @param {object} element
         */
        var getInnerWidth = function(element) {
            var style = window.getComputedStyle(element.node(), null);

            return parseInt(style.getPropertyValue('width'));
        };
    </script>
</body>
</html>
